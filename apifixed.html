<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Load Google API JavaScript library -->
  <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};"
    onreadystatechange="if (this.readyState=='complete') this.onload()"></script>

  <!-- Load custom JavaScript files from GitHub -->
  <script src="OUR GITHUB"></script>
  <script Language="JavaScript" type="text/javascript" src="OUR GITHUB"></script>

  <script>
    $(function () {
      $("#startdate").datepicker({ dateFormat: 'yy-mm-dd' });
      $("#enddate").datepicker({ dateFormat: 'yy-mm-dd' });
    });
  </script>

  <script type="text/javascript">

    function makeNewEvent() {
      var form = collectFormData();
      console.log(form);
      var event = formatEvent(form.fname, form.lname, form.email, form.startDate, form.endDate);
      console.log(event);
    }

    function collectFormData() {
      return {
        'fname': document.getElementById('firstName').value,
        'lname': document.getElementById('lastName').value,
        'email': document.getElementById('email').value,
        'startDate': document.getElementById('startTime').value,
        'endDate': document.getElementById('endTime').value,
      };
    }

  </script>

  <script type="text/javascript">

    var calendarID = 'Whatever our ID is';
    var serviceAccountID = 'Our Service Account';

    // AUTHENTICATION SECTION
    // This entire section deals with Google Service Account authentication to obtain a token
    // Tokens expire every hour and will be regenerated
    // Most of this was found with help online, and then used KJUR api

    // load the corresponding file that contains the key.
    var loadKey = new XMLHttpRequest();
    var hackKUfile;

    loadKey.open('GET', 'OUR KEY', false);
    loadKey.onreadystatechange = function () {
      hackKUfile = JSON.parse(loadKey.response);
    }
    loadKey.send(null);

    var pHeader = { 'alg': 'RS256', 'typ': 'JWT' }
    var sHeader = JSON.stringify(pHeader);

    var pClaim = {};
    pClaim.aud = "https://www.googleapis.com/oauth2/v4/token";
    pClaim.scope = "https://www.googleapis.com/auth/calendar";
    pClaim.iss = serviceAccountID;
    pClaim.exp = KJUR.jws.IntDate.get("now + 1hour");
    pClaim.iat = KJUR.jws.IntDate.get("now");

    var sClaim = JSON.stringify(pClaim);

    var key = hackKUfile.private_key;

    var sJWS = KJUR.jws.JWS.sign(null, sHeader, sClaim, key);

    var XHR = new XMLHttpRequest();
    var urlEncodedData = "";
    var urlEncodedDataPairs = [];

    urlEncodedDataPairs.push(encodeURIComponent("grant_type") + '= ' + encodeURIComponent("urn:ietf:params:oauth:grant-type:jwt-bearer"));
    urlEncodedDataPairs.push(encodeURIComponent("assertion") + '= ' + encodeURIComponent(sJWS));
    urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');

    var token = '';

    XHR.addEventListener('load', function (event) {
      var response = JSON.parse(XHR.responseText);
      token = response["access_token"];
    });

    // Define event creation function
function createEvent(fname, lname, email, start, end) {
  return {
    "end": {
      "date": end
    },
    "start": {
      "date": start
    },
    "summary": "RESERVED",
    "creator": {
      "displayName": fname + " " + lname,
      "email": email,
    }
  };
}

// Define event addition function
function addEvent(event) {
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'https://www.googleapis.com/calendar/v3/calendars/' + calendarID + '/events?access_token=' + token, false);
  xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
  xhr.onreadystatechange = function() {
    console.log('added');
  }
  xhr.send(JSON.stringify(event));
}

// Handle XHR error
xhr.addEventListener('error', function(event) {
  console.log('Oops! Something went wrong.');
});

// Get OAuth token
var XHR = new XMLHttpRequest();
var urlEncodedData = "";
var urlEncodedDataPairs = [];
urlEncodedDataPairs.push(encodeURIComponent("grant_type") + '= ' + encodeURIComponent("urn:ietf:params:oauth:grant-type:jwt-bearer"));
urlEncodedDataPairs.push(encodeURIComponent("assertion") + '= ' + encodeURIComponent(sJWS));
urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');

var token = '';

XHR.addEventListener('load', function(event) {
  var response = JSON.parse(XHR.responseText);
  token = response;
});

XHR.open('POST', 'https://www.googleapis.com/oauth2/v4/token', false);
XHR.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
XHR.send(urlEncodedData);

</script>
</head>
</html>